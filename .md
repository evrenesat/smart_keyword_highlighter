# Bolder Userscript Specification

## 1. Goal
Create a Firefox userscript that improves reading accessibility by bolding specific "important" words while preserving the natural flow of reading.
**Core Logic:**
1.  **Bold** all-uppercase words (e.g., `NASA`, `HTTP`).
2.  **Bold** capitalized words (e.g., `Python`, `Django`).
3.  **Exclude** the first visible word of any block element.
4.  **Exclude** the first word of any sentence.

## 2. Environment
-   **Target**: Firefox (Desktop/Mobile).
-   **Manager**: Tampermonkey / Violentmonkey.
-   **Run At**: `document-idle`.
-   **Scope**: All URLs (`*://*/*`).

## 3. Core Definitions

### 3.1. Word Classification
A "word" is a sequence of ASCII letters `[A-Za-z]`.
-   **Uppercase Word**: `\b[A-Z]{2,}\b` (e.g., "API", "JSON").
    -   *Constraint*: Length >= 2 to avoid "I", "A".
-   **Capitalized Word**: `\b[A-Z][a-z]{2,}\b` (e.g., "Google", "Browser").
    -   *Constraint*: Length >= 3 (1 upper + 2 lower) to avoid common short words like "It", "As" (though sentence start logic handles most, this is a secondary filter).

### 3.2. Sentence Boundary
A sentence ends at a **Terminator**.
-   **Terminators**: `.`, `!`, `?`, `â€¦`.
-   **Logic**: A word is the "start of a sentence" if it is the first word encountered after a Terminator (ignoring whitespace and simple punctuation like `"` `'` `)` `]`).

### 3.3. Block Context
A "Block Context" is a container where text flow resets.
-   **Block Elements**: `DIV`, `P`, `LI`, `TD`, `TH`, `H1`-`H6`, `HEADER`, `FOOTER`, `SECTION`, `ARTICLE`, `ASIDE`, `BLOCKQUOTE`, `FIGCAPTION`.
-   **Rule**: The *very first visible word* found within a Block Element (depth-first traversal) must **never** be bolded.

### 3.4. Visibility & Exclusions
Text nodes are processed ONLY if:
1.  **Visible**:
    -   Not `display: none` or `visibility: hidden`.
    -   Not inside `aria-hidden="true"`.
    -   Not inside `opacity: 0`.
2.  **Allowed Tag**:
    -   **Excluded Tags**: `SCRIPT`, `STYLE`, `NOSCRIPT`, `TEXTAREA`, `INPUT`, `SELECT`, `OPTION`, `CODE`, `PRE`, `IFRAME`, `SVG`, `CANVAS`, `KBD`, `VAR`.
    -   **Excluded Attributes**: `contenteditable="true"`.

## 4. Implementation Logic

### 4.1. Global State
-   `atSentenceStart` (Boolean): Tracks if we are currently at the start of a sentence.
    -   **Initial**: `true`.
    -   **Set to True**: When a Terminator is encountered.
    -   **Set to False**: After processing the first valid word while `atSentenceStart` was true.

### 4.2. Block State
-   `blockFirstWordSeen` (WeakMap<Element, Boolean>): Tracks if a block element has had its first word processed.
    -   **Key**: The nearest ancestor element that matches the **Block Elements** list.
    -   **Value**: `true` if we have already seen a word in this block.

### 4.3. Traversal Algorithm (TreeWalker)
1.  Create a `TreeWalker` for `SHOW_TEXT`.
2.  For each `textNode`:
    a.  **Skip** if ancestor is in **Excluded Tags**.
    b.  **Skip** if ancestor is invisible.
    c.  **Identify Block Parent**: Find nearest Block Element ancestor.
    d.  **Tokenize**: Split text content by boundaries (spaces, punctuation).
    e.  **Process Tokens**:
        i.   If token is a **Terminator**: Set `atSentenceStart = true`.
        ii.  If token is a **Word**:
             -   Check **Block Exclusion**:
                 -   If `blockFirstWordSeen.get(blockParent)` is `false` (or undefined):
                     -   Mark `blockFirstWordSeen.set(blockParent, true)`.
                     -   **SKIP** (Do not bold).
             -   Check **Sentence Exclusion**:
                 -   If `atSentenceStart` is `true`:
                     -   Set `atSentenceStart = false`.
                     -   **SKIP** (Do not bold).
             -   **Bold Candidate**:
                 -   If matches **Uppercase Word** OR **Capitalized Word**:
                     -   Wrap in `<bolder-span>` (Shadow DOM or custom element to avoid style leaks) or `<span style="font-weight:700; color: ...">`.
                     -   *Optimization*: Use a custom tag `<b-b>` or class to avoid reprocessing.

### 4.4. Dynamic Content (MutationObserver)
-   Observe `childList` and `subtree` on `document.body`.
-   On mutation:
    -   Collect added nodes.
    -   Run Traversal on added nodes.
    -   **Context Reset**: Treat new disconnected subtrees as fresh contexts (reset `atSentenceStart` to `true` for the new chunk to be safe, or try to infer from previous sibling? *Decision: Reset to true for robustness*).

## 5. Safety & Performance
-   **Idempotency**: Mark processed elements (e.g., `data-bolder-processed="true"`).
-   **Chunking**: If the page is huge, use `requestIdleCallback` to process in chunks to avoid freezing the main thread.
-   **Shadow DOM**: Explicitly **exclude** Shadow DOM traversal for version 1.0 to keep complexity manageable.

## 6. CSS Styling
Inject a style tag:
```css
b-b {
    font-weight: 700 !important;
    color: inherit; /* Or a high-contrast color if desired */
}
```
Use `<b-b>Word</b-b>` for replacements to keep DOM footprint small.
